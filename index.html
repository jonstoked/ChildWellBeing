
<!DOCTYPE html>
<html>
<head>
	
	<title>Quick Start - Leaflet</title>

	<meta charset="utf-8" />
	<meta name="viewport" content="width=device-width, initial-scale=1.0">

	<link rel="stylesheet" href="https://unpkg.com/leaflet@1.0.1/dist/leaflet.css" />
	<script src="https://unpkg.com/leaflet@1.0.1/dist/leaflet.js"></script>

	<!-- jon's dependencies -->
	<script src="https://ajax.googleapis.com/ajax/libs/jquery/1.12.4/jquery.min.js"></script>
	<script src="https://fastcdn.org/Papa-Parse/4.1.2/papaparse.min.js"></script>

   <style>
	   html, body, #mapid {
	      height:100%;
	      width:100%;
	      padding:0px;
	      margin:0px;
	   } 

	   	#legend {

	   		width: 300px;
	   		height: 72px;
	   		position: absolute;
	   		bottom: 0px;
	   		left:0px;
	   		right:0px;
	   		margin: 19px auto;
	   		background-color: white;
	   		border-radius: 5px;
	   		box-shadow: 1px 1px 1px rgba(0,0,0,0.4);;
	   		z-index: 1000000000;
	   		opacity: 0.9;
	   		color:gray;
	   	}

	   	.box {
	   		display: inline-block;
	   		width: 18%;
	   		height: 22px; 
	   		/*background-color: red;*/
	   	}

	   	.cutoff {
	   		display: inline-block;
	   		text-align: center;
	   		width: 18%;
	   		/*background-color: green;*/
	   	}

   </style>

</head>

<body>
<div id="mapid">
	<div id = "legend">
		<div id = "legendHeader" style="text-align:center; height:26px; line-height: 22px;"><b> Child Well Being Index </b></div>
		<div class = "box" style="margin-left:16px;"></div><div class = "box"></div><div class = "box"></div><div class = "box"></div><div class = "box"></div>
		<div class = "cutoff" style="margin-left:42px;">10</div><div class = "cutoff">20</div><div class = "cutoff">30</div><div class = "cutoff">40</div>
	</div>
</div>
<script>

	var map, areas, indicators, indicatorNames = [], cutoffs;
	// let colors = ["#ffffb2", "#fecc5c", "#fd8d3c", "#f03b20", "#bd0026"];
	let colors = ["#0E5051", "#4FB6A1", "#E2DCB0", "#E69241", "#CF2E1D"]
	var currentIndicator = "";

	setupMap();
	getAreas();

	function setupMap() {

		map = L.map('mapid', {
	    	fullscreenControl: true
		}).setView([33.76, -84.37], 9);

		L.tileLayer('https://api.tiles.mapbox.com/v4/{id}/{z}/{x}/{y}.png?access_token=pk.eyJ1IjoibWFwYm94IiwiYSI6ImNpandmbXliNDBjZWd2M2x6bDk3c2ZtOTkifQ._QA7i5Mpkd_m30IGElHziw', {
			maxZoom: 18,
			attribution: "",
			id: 'mapbox.light'
		}).addTo(map);

	}

	function getAreas() {

		$.get("Indicators.csv", function (data) {
	        var csvdata = Papa.parse(data, {header:true,dynamicTyping:true});
	        indicators = csvdata["data"]
	        indicators.forEach(function(indicator) {
	        	indicatorNames.push(indicator["Indicator"])
	        });
	    });

		$.get("CWBIndex2.csv", function (data) {
	        var csvdata = Papa.parse(data, {header:true,dynamicTyping:true});
	        areas = csvdata["data"]
	        setIndicator(indicatorNames[2])
	        getAreaGeometries()
	    });

	}

    function getAreaGeometries() {

		$.getJSON("zipCodeGeometry.json", function(zipCodeGeometries) {

			zipCodeGeometries.forEach(function(zipCodeGeometry) {

			    areas.forEach(function(area) {

					if(area["ZipCode"] == zipCodeGeometry["properties"]["ZIP"]) {
						area["geojson"] = L.geoJSON(zipCodeGeometry).addTo(map);
						drawHeatForArea(area)
					}
				});
			});
		});
    }

    function setIndicator(indicatorName) {
    	currentIndicator = indicatorName
    	indicators.forEach(function(indicator) {
    		if(currentIndicator == indicator["Indicator"]) { //damn, poor naming dude, but its crunch time, this is a hackathon!
    			updateHeat(currentIndicator,indicator["higherBetter"])
    			updateLegend(indicator["type"])
    		}
    	});
    }

   	function updateHeat(indicator, higherBetter) {

		//min = 50, max = 95
		//max-min = 45
		//given 50, heat should be around 0.9
		//give 90, heat should be around 0.1

    	var min=10000,max=-10000;
    	areas.forEach(function(area) {
    		if(area[indicator] < min) {
    			min = area[indicator]
    		}
    		if(area[indicator] > max) {
    			max = area[indicator]
    		}
    	});

    	updateCutoffs(min,max,higherBetter);

    	areas.forEach(function(area) {
    		let normalizedIndicator = (area[indicator] - min)/(max - min) //between 0 and 1
    		if(higherBetter == true) {
	    		area["heat"] = 1 - normalizedIndicator
	    	} else {
	    		area["heat"] = normalizedIndicator
	    	}
    	});


	}

	function updateCutoffs(min,max,higherBetter) {
		//40-90
		//50/6 = 8.3 = increment

		let range = max-min;
		let numCutoffs = 6.0;
		let increment = range/numCutoffs;

		cutoffs = []
		for (i=1; i<numCutoffs-1; ++i) {
			cutoffs.push(min+i*increment)
		}

		if(higherBetter) {
			cutoffs.reverse();
		}

	}

	function drawHeatForArea(area) {
		
		//heat is always normalized from 0-1
		let color = colorForHeat(area["heat"])

		area["geojson"].setStyle({
		    "weight": 2,
		    "color": color, //stroke
		    "opacity": 0.6, //stroke
		    "fillColor": color,
		    "fillOpacity": 0.6 
		});
	}

	function colorForHeat(heat) {

		let index = Math.ceil(heat*5)-1;
		return colors[index];
		//input 0-1
		//output 0-4

		//0.2*5 = 1
		//0.4*5 = 2
		//1*5 = 5 
	}

	function updateLegend(type) {
		$("#legendHeader").html("<b>" + currentIndicator + "</b>")

		var boxes = $(".box")
		boxes.each(function(i,box) {
			box.style.backgroundColor = colors[i]
		})

		$(".cutoff").each(function(i,cutoff) {
			let value = Math.round( cutoffs[i] * 10) / 10;
			if(type == "percent") {
				cutoff.innerHTML = value + "%"
			} else {
				cutoff.innerHTML = value
			}
		})
	}








  


</script>

</body>
</html>
